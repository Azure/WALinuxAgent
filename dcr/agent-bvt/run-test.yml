parameters:
  - name: sshCommand
    type: string
    default: "mkdir -p $(Build.ArtifactStagingDirectory)/tests/{0}/ && ssh -o StrictHostKeyChecking=no $(adminUsername)@$(armDeploymentOutput.hostname.value) sudo time python3 /home/$(adminUsername)/dcr/$(scenarioName)/{0}.py>$(Build.ArtifactStagingDirectory)/tests/{0}/stdout 2>$(Build.ArtifactStagingDirectory)/tests/{0}/stderr || (ec=$? && echo $ec > $(Build.ArtifactStagingDirectory)/tests/{0}/returncode && exit $ec)"

steps:
  - script: ${{ format(parameters.sshCommand, '01_check_waagent_version') }}
    name: 'checkVersion'

  - script: ${{ format(parameters.sshCommand, '03_check_nslookup') }}
    condition: succeededOrFailed()

  - script: |
      ls $(Build.ArtifactStagingDirectory)/*
      echo "STDOUT:"
      cat $(Build.ArtifactStagingDirectory)/tests/*/stdout
      echo "STDERR:"
      cat $(Build.ArtifactStagingDirectory)/tests/*/stderr
    condition: succeededOrFailed()



