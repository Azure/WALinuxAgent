# Template for dealing with ARM Deployments

parameters:
#  - name: azConn
#    type: string
#  - name: subId
#    type: string
#  - name: rgName
#    type: string
  - name: location
    type: string
    default: ""

steps:
  - script: |
      echo "Location: ${{ parameters.location }}"

  - ${{ if eq(parameters.location, 'East US 2') }}:
    - task: AzureResourceManagerTemplateDeployment@3
      name: "deployVM"
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '${{ variables.publicConn }}'
        subscriptionId: '${{ variables.publicSub }}'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(rgName)'
        location: '${{ parameters.location }}'
        templateLocation: 'URL of the file'
        csmFileLink: 'https://bootdiagsokypwackoodny.blob.core.windows.net/testlinuxagentarm/simple-linux-vm.json?sp=r&st=2021-07-22T18:59:28Z&se=2021-08-01T02:59:28Z&spr=https&sv=2020-08-04&sr=b&sig=eHKXUdBoY2KPqQr3Xs%2FfPCa6yVF%2BGFgDPHRzoip9qbU%3D'
        overrideParameters: '-vmName "$(vmName)" -adminUsername "$(adminUsername)" -adminPasswordOrKey "$(SSH_PUBLIC)"'
        deploymentMode: 'Complete'
        deploymentOutputs: 'armDeploymentOutput'

  - ${{ if eq(parameters.location, 'china north 2') }}:
    - task: AzureResourceManagerTemplateDeployment@3
      name: "deployVM"
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: '${{ variables.mooncakeConn }}'
        subscriptionId: '${{ variables.mooncakeSub }}'
        action: 'Create Or Update Resource Group'
        resourceGroupName: '$(rgName)'
        location: '${{ parameters.location }}'
        templateLocation: 'URL of the file'
        csmFileLink: 'https://bootdiagsokypwackoodny.blob.core.windows.net/testlinuxagentarm/simple-linux-vm.json?sp=r&st=2021-07-22T18:59:28Z&se=2021-08-01T02:59:28Z&spr=https&sv=2020-08-04&sr=b&sig=eHKXUdBoY2KPqQr3Xs%2FfPCa6yVF%2BGFgDPHRzoip9qbU%3D'
        overrideParameters: '-vmName "$(vmName)" -adminUsername "$(adminUsername)" -adminPasswordOrKey "$(SSH_PUBLIC)"'
        deploymentMode: 'Complete'
        deploymentOutputs: 'armDeploymentOutput'