#
# Pipeline for cleaning up any remaining Resource Groups generated by the Azure.WALinuxAgent pipeline.
#
# Deletes any resource groups that are older than 'older_than' and match the 'name_pattern' regular expression
#

parameters:
  - name: name_pattern
    displayName: Regular expression to match the name of the resource groups to delete
    type: string
    default: lisa-WALinuxAgent-.*

  - name: older_than
    displayName: Delete resources older than (use the syntax of the "date -d" command)
    type: string
    default: 1 day ago

  - name: service_connections
    type: object
    default:
      - azuremanagement
#
# TODO: Enable these services connections once we create test pipelines for all Azure clouds
#
#      - azuremanagement.china
#      - azuremanagement.government

pool:
  vmImage: ubuntu-latest

steps:
  - ${{ each service_connection in parameters.service_connections }}:
    - task: AzureCLI@2
      inputs:
        azureSubscription: ${{ service_connection }}
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -euxo pipefail

          #
          # We use the REST API to list the resource groups because we need the createdTime and that
          # property is not available via the az-cli commands.
          #
          subscription_id=$(az account list --all --query "[?isDefault].id" -o tsv)
          
          date=$(date --utc +%Y-%m-%d'T'%H:%M:%S.%N'Z' -d "${{ parameters.older_than }}")

          rest_endpoint=$(az cloud show --query "endpoints.resourceManager" -o tsv)
          
          az rest --method GET \
            --url "${rest_endpoint}/subscriptions/${subscription_id}/resourcegroups" \
            --url-parameters api-version=2021-04-01 \$expand=createdTime \
            --output json \
            --query value \
          | jq --arg date "$date" '.[] | select (.createdTime < $date).name' \
          | grep '${{ parameters.name_pattern }}' \
          | xargs -l -t -r az group delete --no-wait -y -n \
          || echo "No resource groups found to delete"
