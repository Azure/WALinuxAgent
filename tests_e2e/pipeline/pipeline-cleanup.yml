#
# Pipeline for cleaning up any remaining Resource Groups generated by the Azure.WALinuxAgent pipeline.
#
# Deletes any resource groups that are more than a day old and contain string "lisa-WALinuxAgent-"
#
schedules:
  - cron: "0 */12 * * *" # Run twice a day (every 12 hours)
    displayName: cleanup build
    branches:
      include:
      - develop
    always: true

trigger:
  - develop

pr: none

pool:
  vmImage: ubuntu-latest

variables:
  - name: azureConnection
    value: 'azuremanagement'
  - name: rgPrefix
    value: 'lisa-WALinuxAgent-'

steps:

  - task: AzureKeyVault@2
    displayName: "Fetch secrets from KV"
    inputs:
      azureSubscription: '$(azureConnection)'
      KeyVaultName: 'dcrV2SPs'
      SecretsFilter: '*'
      RunAsPreJob: true

  - task: AzureCLI@2
    inputs:
      azureSubscription: '$(azureConnection)'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        set -euxo pipefail
        date=`date --utc +%Y-%m-%d'T'%H:%M:%S.%N'Z' -d "1 day ago"`
  
        # Using the Azure REST GET resourceGroups API call as we can add the createdTime to the results.
        # This feature is not available via the az-cli commands directly so we have to use the Azure REST APIs
  
        az rest --method GET \
          --url "https://management.azure.com/subscriptions/$(SUBSCRIPTION-ID)/resourcegroups" \
          --url-parameters api-version=2021-04-01 \$expand=createdTime \
          --output json \
          --query value \
        | jq --arg date "$date" '.[] | select (.createdTime < $date).name' \
        | grep "$(rgPrefix)" \
        | xargs -l -t -r az group delete --no-wait -y -n \
        || echo "No resource groups found to delete"
