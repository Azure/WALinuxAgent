jobs:
  - job: "ExecuteTests"

    steps:

      - task: DownloadSecureFile@1
        name: downloadSshKey
        displayName: "Download SSH key"
        inputs:
          secureFile: 'id_rsa'

      - task: AzureKeyVault@2
        displayName: "Fetch secrets from KV"
        inputs:
          azureSubscription: '$(azureConnection)'
          KeyVaultName: 'dcrV2SPs'
          SecretsFilter: '*'
          RunAsPreJob: true

      - task: UsePythonVersion@0
        displayName: "Set Python Version"
        inputs:
          versionSpec: '3.10'
          addToPath: true
          architecture: 'x64'

      - bash: $(Build.SourcesDirectory)/tests_e2e/scripts/execute_tests_container.sh
        displayName: "Execute tests"
        env:
          # Add all KeyVault secrets explicitly as they're not added by default to the environment vars
          AZURE_CLIENT_ID: $(AZURE-CLIENT-ID)
          AZURE_CLIENT_SECRET: $(AZURE-CLIENT-SECRET)
          AZURE_TENANT_ID: $(AZURE-TENANT-ID)
          SUBSCRIPTION_ID: $(SUBSCRIPTION-ID)

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/*junit.xml'
          searchFolder: $(Build.ArtifactStagingDirectory)
          testRunTitle: 'Publish test results'

      - publish: $(Build.ArtifactStagingDirectory)
        artifact: 'test-logs'
        displayName: 'Publish test logs'
