name: $(name)

testcase:
  - criteria:
      area: waagent

extension:
  - "./lib"

variable:
  #
  # The test environments are generated dynamically by the AgentTestSuitesCombinator using the 'platform' and 'environment' variables.
  # Most of the variables below are parameters for the combinator and/or the AgentTestSuite (marked as 'is_case_visible'), but a few of
  # them, such as the runbook name and the SSH proxy variables, are handled by LISA.
  #
  # Many of these variables are optional, depending on the scenario. An empty values indicates that the variable has not been specified.
  #

  #
  # The name of the runbook, it is added as a prefix ("lisa-<name>") to ARM resources created by the test run.
  #
  # Set the name to your email alias when doing developer runs.
  #
  - name: name
    value: "WALinuxAgent"
    is_case_visible: true

  #
  # Test suites to execute
  #
  - name: test_suites
    value: "agent_bvt, no_outbound_connections, extensions_disabled, agent_not_provisioned, fips, agent_ext_workflow, agent_status, multi_config_ext, agent_cgroups, ext_cgroups, agent_firewall, ext_telemetry_pipeline, ext_sequencing"

  #
  # Parameters used to create test VMs
  #
  - name: subscription_id
    value: ""
    is_case_visible: true
  - name: cloud
    value: "AzureCloud"
    is_case_visible: true
  - name: location
    value: ""
  - name: image
    value: ""
  - name: vm_size
    value: ""

  #
  # Whether to skip deletion of the test VMs after the test run completes.
  #
  # Possible values: always, no, failed
  #
  - name: keep_environment
    value: "no"
    is_case_visible: true

  #
  # Username and SSH public key for the admin user on the test VMs
  #
  - name: user
    value: "waagent"
    is_case_visible: true
  - name: identity_file
    value: ""
    is_case_visible: true

  #
  # Set the resource group and vm, or the group and the vmss, to execute the test run on an existing VM or VMSS.
  #
  - name: resource_group_name
    value: ""
    is_case_visible: true
  - name: vm_name
    value: ""
    is_case_visible: true
  - name: vmss_name
    value: ""
    is_case_visible: true

  #
  # Directory for test logs
  #
  - name: log_path
    value: ""
    is_case_visible: true

  #
  # Whether to collect logs from the test VM
  #
  # Possible values: always, no, failed
  #
  - name: collect_logs
    value: "failed"
    is_case_visible: true

  #
  # Whether to skip setup of the test VMs. This is useful in developer runs when using existing VMs to save initialization time.
  #
  - name: skip_setup
    value: false
    is_case_visible: true

  #
  # These variables are handled by LISA to use an SSH proxy when executing the runbook
  #
  - name: proxy
    value: False
  - name: proxy_host
    value: ""
  - name: proxy_user
    value: "foo"
  - name: proxy_identity_file
    value: ""
    is_secret: true

  #
  # The variables below are generated by the AgentTestSuitesCombinator combinator. They are
  # prefixed with "c_" to distinguish them from the rest of the variables, whose value can be set from
  # the command line.
  #

  #
  # The combinator generates the test environments using these two variables, which are passed to LISA
  #
  - name: c_environment
    value: {}
  - name: c_platform
    value: []

  #
  # Name of the test environment, used for mainly for logging purposes
  #
  - name: c_env_name
    value: ""
    is_case_visible: true

  #
  # Test suites assigned for execution in the current test environment.
  #
  # The combinator splits the test suites specified in the 'test_suites' variable in subsets and assigns each subset
  # to a test environment. The AgentTestSuite uses 'c_test_suites' to execute the suites assigned to the current environment.
  #
  - name: c_test_suites
    value: []
    is_case_visible: true

  #
  # These parameters are used by the AgentTestSuite to create the test scale sets.
  #
  # Note that there are other 3 variables named 'image', 'vm_size' and 'location', which can be passed
  # from the command line. The combinator generates the values for these parameters using test metadata,
  # but they can be overriden with these command line variables. The final values are passed to the
  # AgentTestSuite in the corresponding 'c_*' variables.
  #
  - name: c_image
    value: ""
    is_case_visible: true
  - name: c_vm_size
    value: ""
    is_case_visible: true
  - name: c_location
    value: ""
    is_case_visible: true

  #
  # True if the image is a VHD (instead of a URN)
  #
  - name: c_is_vhd
    value: false
    is_case_visible: true

environment: $(c_environment)

platform: $(c_platform)

combinator:
  type: agent_test_suites
  cloud: $(cloud)
  identity_file: $(identity_file)
  image: $(image)
  keep_environment: $(keep_environment)
  location: $(location)
  resource_group_name: $(resource_group_name)
  subscription_id: $(subscription_id)
  test_suites: $(test_suites)
  user: $(user)
  vm_name: $(vm_name)
  vm_size: $(vm_size)
  vmss_name: $(vmss_name)

concurrency: 32

notifier:
  - type: agent.junit

dev:
  enabled: $(proxy)
  mock_tcp_ping: $(proxy)
  jump_boxes:
    - private_key_file: $(proxy_identity_file)
      address: $(proxy_host)
      username: $(proxy_user)
      password: "dummy"

